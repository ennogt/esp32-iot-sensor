# ESP32 IoT Temperature & Humidity Sensor

Monitor temperature and humidity using a DHT22/AM2301 sensor connected to an ESP32 microcontroller. Displays readings on an OLED display and publishes to Home Assistant via MQTT with auto-discovery support.

## Features

- **DHT22/AM2301** sensor integration
- **OLED SSD1306** display (128×32, I2C)
- **MQTT** with Home Assistant auto-discovery
- **Wi-Fi Provisioning** via SoftAP (no pre-configured SSID needed)
- **Dynamic device identification** – multiple sensors can coexist via MAC address suffix
- **Configurable thresholds** – publish only on meaningful changes
- **Configuration via Kconfig** – environment-specific settings without Git conflicts

## Quick Start

### Prerequisites

- ESP-IDF v5.0+
- ESP32 or ESP32-C6 board
- DHT22 or AM2301 sensor
- SSD1306 OLED display (128×32)
- Basic ESP-IDF setup

### Build & Flash

```bash
# 1. Configure for your environment
idf.py menuconfig
# → Navigate to "IoT Sensor Configuration"
# → Set your MQTT broker, WiFi, GPIO pins

# 2. Build and flash
idf.py build
idf.py flash

# 3. Monitor output
idf.py monitor
```

### Configuration

All settings are managed via **Kconfig** (ESP-IDF's build configuration system):

```bash
idf.py menuconfig
```

Navigate to **"IoT Sensor Configuration"** to adjust settings such as:

- MQTT broker URI, username & password
- Device friendly name (optional, or auto-generated from MAC address)
- WiFi provisioning hotspot name
- Hardware GPIO pins (button, sensor, display)
- Sensor thresholds and heartbeat intervals

For a complete list of available options, see [`main/Kconfig.projbuild`](main/Kconfig.projbuild).

#### How Configuration Works

1. **`main/Kconfig.projbuild`** defines all available options
   - Automatically parsed by ESP-IDF build system
   - Organized into logical menus

2. **`sdkconfig`** stores your personal choices (generated by menuconfig)
   - Each device/developer has their own `sdkconfig`
   - Already included in `.gitignore` – **DO NOT commit this file**

3. **`main/config.h`** bridges Kconfig values to C code
   - Includes auto-generated `sdkconfig.h`
   - Maps `CONFIG_*` macros to application defines
   - Safe to commit (no secrets or environment-specific data)

#### Example: Setting Up a New Device

```bash
# 1. Clone the repository
git clone <repo-url>
cd esp32-iot-sensor

# 2. Configure for your environment
idf.py menuconfig
# → Set MQTT broker, credentials, GPIO pins, etc.

# 3. Build and flash
idf.py build
idf.py flash
idf.py monitor
```

Each device maintains its own `sdkconfig` with unique settings.

## Hardware Configuration (Default)

| Component    | GPIO | Bus   |
| ------------ | ---- | ----- |
| Reset Button | 4    | —     |
| DHT22 Sensor | 10   | —     |
| OLED SDA     | 20   | I2C 0 |
| OLED SCL     | 19   | I2C 0 |

Adjust in `idf.py menuconfig` → "Hardware Pin Configuration" if using different pins.

## Home Assistant Integration

This device publishes to MQTT with auto-discovery. Home Assistant will automatically create entities for:

- Temperature sensor
- Humidity sensor

**Topics:**

- `homeassistant/sensor/esp32-sensor-XXYYZZ/state` – sensor readings
- `homeassistant/sensor/esp32-sensor-XXYYZZ_temp/config` – temperature auto-discovery
- `homeassistant/sensor/esp32-sensor-XXYYZZ_hum/config` – humidity auto-discovery

Where `XXYYZZ` is the last 3 bytes of the device's MAC address (6 hex digits).

## Multiple Devices

Each device gets a **unique device ID** based on its MAC address. You can run multiple sensors with the same firmware:

1. Build once: `idf.py build`
2. Flash to device 1: `idf.py flash`
3. Flash to device 2: `idf.py flash` (to a different board)

Each will:

- Auto-generate a unique device name
- Use unique MQTT topics
- Register separately in Home Assistant

To use **custom friendly names** for each device:

```bash
idf.py menuconfig
# → Enable "Use custom device name"
# → Set name (e.g., "Living Room Sensor")
# → Save and build
```

## WiFi Setup (Provisioning)

On first boot (or after a reset):

1. The display shows "Provisioning Mode".
2. Device creates a **SoftAP hotspot** named `PROV_ESP32_SENSOR` (configurable).
3. Use the **ESP SoftAP Prov** app (available for iOS/Android) to provision:
   - Connect to the hotspot in the app
   - Select your WiFi network and enter password
4. Device connects, saves credentials, and reboots into normal operation.

**Reset WiFi credentials:** While the device is running, hold the button (GPIO 4) for **3 seconds**. The display will show "Resetting WiFi...", clear stored credentials, and reboot into Provisioning Mode.

**Short Press:** A short press on the button toggles the OLED display on/off.

## Advanced: Multiple Configuration Profiles

If you need different profiles for multiple environments (e.g., "office", "bedroom"):

```bash
# Save current config as a profile
cp sdkconfig sdkconfig.office

# Switch to another profile
cp sdkconfig.bedroom sdkconfig
idf.py build
idf.py flash

# Switch back
cp sdkconfig.office sdkconfig
```
